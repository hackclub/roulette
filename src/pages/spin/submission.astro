---
import Layout from '../../layouts/Layout.astro';
import LinkButton from "../../components/LinkButton.astro";
import InlineArrow from "../../components/InlineArrow.astro";
import { requireUser, redirectToLogin } from '../../lib/auth.js';
import { getCurrentRound } from '../../lib/data.js';
import { getProjectsSinceRoundNum } from '../../lib/hackatime.js';
import { getUserRound, getUserBySlackId } from '../../lib/airtable.js';

export const prerender = false;

// Get user data
let userData;
let currentRound;
let hackatimeProjects = [];
let wagerData = null;

try {
  userData = await requireUser(Astro.request.headers);
  currentRound = getCurrentRound();
  const slackId = userData.fields.slackId;
  
  // Fetch hackatime projects for this user
  try {
    if (slackId) {
      hackatimeProjects = await getProjectsSinceRoundNum(slackId, currentRound);
    }
  } catch (error) {
    console.error('Failed to fetch hackatime projects:', error);
  }

  // Fetch wager data directly from Airtable instead of API call
  try {
    if (slackId) {
      const userRound = await getUserRound(slackId, currentRound);
      const user = await getUserBySlackId(slackId);
      
      if (userRound && user) {
        wagerData = {
          wagerChoice: userRound.fields.wagerChoice,
          wagerAmount: userRound.fields.wagerAmount,
          currentChips: user.fields.chips,
          currentRespins: user.fields.respinTokens || 0,
          targetHours: getTargetHours(userRound.fields.wagerChoice),
          spinCamera: userRound.fields.spinCamera || '—',
          spinGameplay: userRound.fields.spinGameplay || '—',
          spinSetting: userRound.fields.spinSetting || '—'
        };
      }
    }
  } catch (error) {
    console.error('Failed to fetch wager data:', error);
  }
} catch (error) {
  return Astro.redirect('/');
}

// Helper function to calculate target hours
function getTargetHours(wagerChoice) {
  const multiplierToHours = { '1.5x': 5, '2x': 10, '3x': 25 };
  return multiplierToHours[wagerChoice] || 0;
}

// Extract wager information
const wagerChoice = wagerData?.wagerChoice || '1.5x';
const wagerAmount = wagerData?.wagerAmount || 0;
const currentChips = wagerData?.currentChips || 0;
const currentRespins = wagerData?.currentRespins || 0;
const targetHours = wagerData?.targetHours || 0;
---

<Layout>
  <main>
    <a href="/spin"><InlineArrow reversed pink /> back to dashboard</a>

    <div class="submission-container">
      <h1>submit your round</h1>

      <form id="submission-form">
        <div class="form-section">
          <label for="game-name">game name</label>
          <input type="text" id="game-name" name="game-name" class="styled-input" placeholder="enter your game name..." required>
        </div>

        <div class="form-section">
          <label for="game-description">game description</label>
          <textarea id="game-description" name="game-description" class="styled-textarea" placeholder="describe what you built..." required></textarea>
        </div>

        <div class="form-section">
          <label for="game-screenshot">game screenshot url</label>
          <input type="url" id="game-screenshot" name="game-screenshot" class="styled-input" placeholder="https://github.com/.../screenshot.png">
          <div id="screenshot-preview" class="screenshot-preview" style="display: none;">
            <img id="preview-image" alt="Screenshot preview">
            <button type="button" id="remove-screenshot" class="remove-btn">× remove</button>
          </div>
          <p class="help-text">put your screenshot in your github repo, then right click and copy image address to paste here</p>
        </div>

        <div class="form-section">
          <label for="github-url">github url</label>
          <input type="url" id="github-url" name="github-url" class="styled-input" placeholder="https://github.com/..." required>
        </div>

        <div class="form-section">
          <label for="playable-url">playable url</label>
          <input type="url" id="playable-url" name="playable-url" class="styled-input" placeholder="https://..." required>
        </div>

        <div class="form-section">
          <label for="hackatime-projects">select hackatime projects</label>
          <div class="hackatime-container">
            <input type="text" id="project-search" class="styled-input search-input" placeholder="search projects...">
            <div class="projects-list">
              {hackatimeProjects.length > 0 ? (
                hackatimeProjects.map((project, index) => (
                  <div class="project-item">
                    <input type="checkbox" id={`project-${index}`} name="hackatime-projects" value={project.name || project.id || `project-${index}`}>
                    <label for={`project-${index}`}>{project.name || `Project ${index + 1}`} ({project.text})</label>
                  </div>
                ))
              ) : (
                <p class="no-projects">No projects found for this round</p>
              )}
            </div>
          </div>
        </div>

        <div class="form-section">
          <label for="theme-justification">theme justification</label>
          <div class="theme-justification-container">
            <div class="spins-display">
              <p class="spins-label">your spins were:</p>
              <div class="spins-list">
                <span class="spin-item">camera: <strong>{wagerData?.spinCamera || '—'}</strong></span>
                <span class="spin-item">gameplay: <strong>{wagerData?.spinGameplay || '—'}</strong></span>
                <span class="spin-item">setting: <strong>{wagerData?.spinSetting || '—'}</strong></span>
              </div>
            </div>
            <div class="justification-input">
              <label for="theme-explanation">explain how your game links to the themes given</label>
              <textarea id="theme-explanation" name="theme-explanation" class="styled-textarea" placeholder="describe how your game connects to the camera, gameplay, and setting themes you spun... (it's ok if it's a bit off — as long as you tried!)" required></textarea>
            </div>
          </div>
        </div>

        <div class="form-section">
          <label for="additional-hours">additional hours</label>
          <div class="additional-hours-container">
            <div class="hours-input-row">
              <input type="number" id="hours-number" name="hours-number" class="styled-input hours-input" placeholder="0" min="0" step="0.5">
              <span class="hours-label">hours</span>
            </div>
            <textarea id="hours-description" name="hours-description" class="styled-textarea" placeholder="describe what you worked on..."></textarea>
            
            <div class="justification-links">
              <label for="justification-links">justification links (github repo links to proofs, journals, etc.)</label>
              <div id="justification-links-container">
                <div class="link-input-row">
                  <input type="url" class="styled-input justification-link" placeholder="https://github.com/.../proof1.pdf">
                  <button type="button" class="remove-link-btn">×</button>
                </div>
              </div>
              <button type="button" id="add-justification-link" class="add-link-btn">+ add another link</button>
              <p class="help-text">put your proof files (PDFs, screenshots, etc.) into your github repo and paste the links here!</p>
            </div>
          </div>
        </div>

        <div class="form-section">
          <div class="combined-summary">
            <h3>total hours & rewards</h3>
            <div class="summary-content">
              <div class="hours-section">
                <div><span class="total-amount">0h</span> / <span class="target-display">{targetHours > 0 ? `${targetHours}h` : '—'}</span> target</div>
                <div class="breakdown-details">(0 hackatime · 0 self-reported)</div>
              </div>
              
              <div class="expected-rewards">
                <p>once you submit, you will get:</p>
                <div class="rewards-breakdown">
                  <span class="chips-reward" data-wager-choice={wagerChoice} data-wager-amount={wagerAmount} data-current-chips={currentChips}>
                    <span class="chips-text">calculating...</span> (<span id="chips-total">{currentChips}</span> total)
                  </span> 
                  <span class="respin-reward" data-current-respins={currentRespins}>
                    <span class="respin-text">+ 0 respin tokens</span> (<span id="respin-total">{currentRespins}</span> total)
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="form-actions" style="align-items: center;">
          <span><a href="/spin" class="cancel-btn">cancel</a></span>
          <button type="submit" id="submit-btn" class="button linkbutton">submit round</button>
        </div>
      </form>
    </div>
  </main>
</Layout>

<script define:vars={{ hackatimeProjects, wagerData }}>
  document.addEventListener('DOMContentLoaded', () => {
    const searchInput = document.getElementById('project-search');
    const projectItems = document.querySelectorAll('.project-item');

    searchInput.addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase().trim();
      
      projectItems.forEach(item => {
        const label = item.querySelector('label');
        const projectName = label.textContent.toLowerCase();
        
        if (projectName.includes(searchTerm)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    });

    // Screenshot preview functionality
    const screenshotInput = document.getElementById('game-screenshot');
    const previewContainer = document.getElementById('screenshot-preview');
    const previewImage = document.getElementById('preview-image');
    const removeBtn = document.getElementById('remove-screenshot');

    screenshotInput.addEventListener('input', (e) => {
      const url = e.target.value.trim();
      if (url && isValidImageUrl(url)) {
        previewImage.src = url;
        previewContainer.style.display = 'block';
      } else {
        previewContainer.style.display = 'none';
      }
    });

    function isValidImageUrl(url) {
      try {
        const urlObj = new URL(url);
        return urlObj.protocol === 'https:' && /\.(png|jpg|jpeg|gif|webp)$/i.test(urlObj.pathname);
      } catch {
        return false;
      }
    }

    removeBtn.addEventListener('click', () => {
      screenshotInput.value = '';
      previewContainer.style.display = 'none';
      previewImage.src = '';
    });

    // Justification links handling
    const addLinkBtn = document.getElementById('add-justification-link');
    const linksContainer = document.getElementById('justification-links-container');

    addLinkBtn.addEventListener('click', () => {
      const linkRow = document.createElement('div');
      linkRow.className = 'link-input-row';
      linkRow.innerHTML = `
        <input type="url" class="styled-input justification-link" placeholder="https://github.com/.../proof.pdf">
        <button type="button" class="remove-link-btn">×</button>
      `;
      
      // Add remove functionality to new row
      const removeBtn = linkRow.querySelector('.remove-link-btn');
      removeBtn.addEventListener('click', () => {
        linkRow.remove();
      });
      
      linksContainer.appendChild(linkRow);
    });

    // Add remove functionality to initial row
    const initialRemoveBtn = linksContainer.querySelector('.remove-link-btn');
    initialRemoveBtn.addEventListener('click', () => {
      const linkRow = initialRemoveBtn.closest('.link-input-row');
      if (linksContainer.children.length > 1) {
        linkRow.remove();
      }
    });

    // Total hours calculation
    const totalAmountSpan = document.querySelector('.total-amount');
    const breakdownDetailsSpan = document.querySelector('.breakdown-details');
    const hoursInput = document.getElementById('hours-number');

    function updateTotalHours() {
      let hackatimeTotalMinutes = 0;
      let selfReportedTotalMinutes = 0;

      // Calculate hackatime minutes from selected projects
      const projectCheckboxes = document.querySelectorAll('input[name="hackatime-projects"]:checked');
      projectCheckboxes.forEach(checkbox => {
        const projectIndex = parseInt(checkbox.id.replace('project-', ''));
        const project = hackatimeProjects[projectIndex];
        if (project) {
          const projectHours = parseFloat(project.hours) || 0;
          const projectMinutes = parseFloat(project.minutes) || 0;
          // Convert hours to minutes and add the minutes field
          const totalProjectMinutes = Math.round(projectHours * 60) + projectMinutes;
          hackatimeTotalMinutes += totalProjectMinutes;
        }
      });

      // Get self-reported hours and convert to minutes
      const selfReportedHours = parseFloat(hoursInput.value) || 0;
      selfReportedTotalMinutes = Math.round(selfReportedHours * 60);

      // Calculate total minutes
      const totalMinutes = hackatimeTotalMinutes + selfReportedTotalMinutes;

      // Convert back to hours and minutes for display
      const totalHours = Math.floor(totalMinutes / 60);
      const totalRemainingMinutes = totalMinutes % 60;

      // Format display strings
      const hackatimeHours = Math.floor(hackatimeTotalMinutes / 60);
      const hackatimeMinutes = hackatimeTotalMinutes % 60;
      const selfReportedHoursDisplay = Math.floor(selfReportedTotalMinutes / 60);
      const selfReportedMinutes = selfReportedTotalMinutes % 60;

      // Update total display
      if (totalRemainingMinutes > 0) {
        totalAmountSpan.textContent = `${totalHours}h ${totalRemainingMinutes}min`;
      } else {
        totalAmountSpan.textContent = `${totalHours}h`;
      }

      // Update breakdown display
      let hackatimeDisplay = '';
      if (hackatimeMinutes > 0) {
        hackatimeDisplay = `${hackatimeHours}h ${hackatimeMinutes}min`;
      } else {
        hackatimeDisplay = `${hackatimeHours}h`;
      }

      let selfReportedDisplay = '';
      if (selfReportedMinutes > 0) {
        selfReportedDisplay = `${selfReportedHoursDisplay}h ${selfReportedMinutes}min`;
      } else {
        selfReportedDisplay = `${selfReportedHoursDisplay}h`;
      }

      breakdownDetailsSpan.textContent = `(${hackatimeDisplay} hackatime · ${selfReportedDisplay} self-reported)`;

      // Update submission summary when hours change
      updateSubmissionSummary();
    }

    // Update submission summary with wager and reward information
    function updateSubmissionSummary() {
      console.log('Updating submission summary...'); // Debug log
      
      // Debug: Inspect the actual rendered HTML
      console.log('=== DOM INSPECTION ===');
      const rewardsBreakdown = document.querySelector('.rewards-breakdown');
      if (rewardsBreakdown) {
        console.log('Rewards breakdown HTML:', rewardsBreakdown.innerHTML);
        console.log('Rewards breakdown outerHTML:', rewardsBreakdown.outerHTML);
      } else {
        console.log('Rewards breakdown container not found!');
      }
      
      // Get wager data from server-side (stored in data attributes)
      const chipsReward = document.querySelector('.chips-reward');
      const respinReward = document.querySelector('.respin-reward');
      const chipsTotalSpan = document.getElementById('chips-total');
      const respinTotalSpan = document.getElementById('respin-total');
      
      console.log('Elements found:', {
        chipsReward: chipsReward ? 'FOUND' : 'MISSING',
        respinReward: respinReward ? 'FOUND' : 'MISSING',
        chipsTotalSpan: chipsTotalSpan ? 'FOUND' : 'MISSING',
        respinTotalSpan: respinTotalSpan ? 'FOUND' : 'MISSING'
      });
      
      console.log('DOM structure:', {
        'chips-reward elements': document.querySelectorAll('.chips-reward').length,
        'respin-reward elements': document.querySelectorAll('.respin-reward').length,
        'chips-total elements': document.querySelectorAll('#chips-total').length,
        'respin-total elements': document.querySelectorAll('#respin-total').length
      });
      
      // Debug: Log the actual elements to see what we're getting
      console.log('Raw elements:', {
        chipsReward: chipsReward,
        respinReward: respinReward,
        chipsTotalSpan: chipsTotalSpan,
        respinTotalSpan: respinTotalSpan
      });
      
      // Debug: Check if elements exist by class name
      console.log('All elements with class chips-reward:', document.querySelectorAll('.chips-reward'));
      console.log('All elements with class respin-reward:', document.querySelectorAll('.respin-reward'));
      
      // Debug: Show the data attributes values
      if (chipsReward) {
        console.log('Chips reward data attributes:', {
          wagerChoice: chipsReward.dataset.wagerChoice,
          wagerAmount: chipsReward.dataset.wagerAmount,
          currentChips: chipsReward.dataset.currentChips
        });
      }
      
      if (respinReward) {
        console.log('Respin reward data attributes:', {
          currentRespins: respinReward.dataset.currentRespins
        });
      }
      
      if (chipsReward && respinReward && chipsTotalSpan && respinTotalSpan) {
        // Extract wager data from data attributes
        const wagerChoice = chipsReward.dataset.wagerChoice || '1.5x';
        const wagerAmount = parseInt(chipsReward.dataset.wagerAmount) || 0;
        const currentChips = parseInt(chipsReward.dataset.currentChips) || 0;
        const currentRespins = parseInt(respinReward.dataset.currentRespins) || 0;
        
        console.log('Wager data extracted:', { wagerChoice, wagerAmount, currentChips, currentRespins });
        
        // Get current total hours and target hours
        const currentHoursText = document.querySelector('.total-amount').textContent;
        const currentHours = parseFloat(currentHoursText.replace('h', '').replace('min', '')) || 0;
        const targetHours = parseFloat(document.querySelector('.target-display').textContent.replace('h', '')) || 0;
        const hoursAboveTarget = Math.max(0, currentHours - targetHours);
        const expectedRespins = Math.floor(hoursAboveTarget / 3);
        
        console.log('Hours calculation:', { currentHours, targetHours, hoursAboveTarget, expectedRespins }); // Debug log
        
        // Only show expected chips if hours meet or exceed target
        if (currentHours >= targetHours) {
          // Calculate expected chips (wager amount × multiplier)
          const multiplierValues = { '1.5x': 1.5, '2x': 2, '3x': 3 };
          const multiplier = multiplierValues[wagerChoice] || 1.5;
          const expectedChips = Math.round(wagerAmount * multiplier);
          
          console.log('Chips calculation (hours >= target):', {
            wagerAmount,
            wagerChoice,
            multiplier,
            expectedChips,
            currentChips,
            totalChips: currentChips + expectedChips
          });
          
          // Update the chips-text span instead of the entire chipsReward
          const chipsText = chipsReward.querySelector('.chips-text');
          if (chipsText) {
            chipsText.textContent = `${expectedChips} chips`;
          }
          chipsTotalSpan.textContent = currentChips + expectedChips;
        } else {
          // Show that hours are insufficient
          const hoursNeeded = targetHours - currentHours;
          // Update the chips-text span instead of the entire chipsReward
          const chipsText = chipsReward.querySelector('.chips-text');
          if (chipsText) {
            if (targetHours > 0) {
              chipsText.textContent = `need ${hoursNeeded}h more to earn chips`;
            } else {
              // If no target hours set, show default chips calculation
              const multiplierValues = { '1.5x': 1.5, '2x': 2, '3x': 3 };
              const multiplier = multiplierValues[wagerChoice] || 1.5;
              const expectedChips = Math.round(wagerAmount * multiplier);
              
              console.log('Chips calculation (no target hours):', {
                wagerAmount,
                wagerChoice,
                multiplier,
                expectedChips,
                currentChips,
                totalChips: currentChips + expectedChips
              });
              
              chipsText.textContent = `${expectedChips} chips`;
            }
          }
          chipsTotalSpan.textContent = currentChips;
        }
        
        // Update respin tokens
        const respinText = respinReward.querySelector('.respin-text');
        if (respinText) {
          respinText.textContent = `+ ${expectedRespins} respin tokens`;
        }
        respinTotalSpan.textContent = currentRespins + expectedRespins;
        
        console.log('Updated display elements'); // Debug log
      } else {
        console.log('Some elements not found, cannot update display'); // Debug log
        console.log('Missing elements:', {
          chipsReward: !chipsReward,
          respinReward: !respinReward,
          chipsTotalSpan: !chipsTotalSpan,
          respinTotalSpan: !respinTotalSpan
        });
      }
    }

    // Add event listeners for real-time updates
    function addProjectCheckboxListeners() {
      const projectCheckboxes = document.querySelectorAll('input[name="hackatime-projects"]');
      projectCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          updateTotalHours();
          // Only update summary if elements exist
          if (document.getElementById('chips-total')) {
            updateSubmissionSummary();
          }
        });
      });
    }

    // Add listener to hours input
    hoursInput.addEventListener('input', () => {
      updateTotalHours();
      // Only update summary if elements exist
      if (document.getElementById('chips-total')) {
        updateSubmissionSummary();
      }
    });

    // Add listeners to existing checkboxes and set up observer for dynamic content
    addProjectCheckboxListeners();

    // Set up mutation observer to handle dynamically added checkboxes
    const observer = new MutationObserver((mutations) => {
      mutations.forEach((mutation) => {
        if (mutation.type === 'childList') {
          addProjectCheckboxListeners();
          // Only update summary if elements exist
          if (document.getElementById('chips-total')) {
            updateSubmissionSummary();
          }
        }
      });
    });

    const projectsList = document.querySelector('.projects-list');
    if (projectsList) {
      observer.observe(projectsList, { childList: true });
    }

    // Initial calculation
    updateTotalHours();

    // Update submission summary immediately and also with delay as backup
    updateSubmissionSummary();
    setTimeout(() => {
      updateSubmissionSummary();
    }, 100);

    // Form submission handling
    const form = document.getElementById('submission-form');
    const submitBtn = document.getElementById('submit-btn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Validate required fields
      const requiredFields = [
        'game-name', 'game-description', 'github-url', 'playable-url', 'theme-explanation'
      ];

      let isValid = true;
      const missingFields = [];

      requiredFields.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (!field.value.trim()) {
          isValid = false;
          const displayName = fieldName === 'theme-explanation' ? 'theme explanation' : fieldName.replace('-', ' ');
          missingFields.push(displayName);
        }
      });

      // Check if user has either hackatime projects OR additional hours
      const selectedProjects = document.querySelectorAll('input[name="hackatime-projects"]:checked');
      const additionalHours = parseFloat(document.getElementById('hours-number').value) || 0;
      
      const hasHackatimeProjects = selectedProjects.length > 0;
      const hasAdditionalHours = additionalHours > 0;
      
      if (!hasHackatimeProjects && !hasAdditionalHours) {
        isValid = false;
        missingFields.push('either hackatime projects or additional hours');
      }

      // Only require hours description if additional hours are entered
      if (hasAdditionalHours) {
        const hoursDescription = document.getElementById('hours-description').value.trim();
        if (!hoursDescription) {
          isValid = false;
          missingFields.push('hours description');
        }
      }

      if (!isValid) {
        alert(`Please fill in all required fields: ${missingFields.join(', ')}`);
        return;
      }

      // Collect form data
      const formData = {
        gameName: document.getElementById('game-name').value.trim(),
        gameDescription: document.getElementById('game-description').value.trim(),
        githubUrl: document.getElementById('github-url').value.trim(),
        playableUrl: document.getElementById('playable-url').value.trim(),
        hoursDescription: document.getElementById('hours-description').value.trim(),
        totalHours: document.querySelector('.total-amount').textContent,
        hackatimeProjects: Array.from(selectedProjects).map(project => project.value),
        additionalHours: additionalHours,
        screenshotUrl: document.getElementById('game-screenshot').value.trim() || '',
        justificationLinks: Array.from(document.querySelectorAll('.justification-link'))
          .map(input => input.value.trim())
          .filter(link => link.length > 0),
        themeExplanation: document.getElementById('theme-explanation').value.trim(),
        spinCamera: wagerData?.spinCamera || '—',
        spinGameplay: wagerData?.spinGameplay || '—',
        spinSetting: wagerData?.spinSetting || '—'
      };

      // Disable submit button and show loading state
      submitBtn.disabled = true;
      submitBtn.textContent = 'submitting...';

      try {
        const response = await fetch('/api/submit-project', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(formData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Failed to submit: ${response.status}`);
        }

        const result = await response.json();
        
        // Success - redirect to spin page
        alert('Project submitted successfully!');
        window.location.href = '/spin';
        
      } catch (error) {
        console.error('Error submitting project:', error);
        alert(`Failed to submit project: ${error.message}`);
        
        // Re-enable submit button
        submitBtn.disabled = false;
        submitBtn.textContent = 'submit round';
      }
    });
  });
</script>

<style>
  main {
    padding: 40px;
    max-width: 800px;
    margin: 0 auto;
  }

  .submission-container {
    margin-top: 40px;
  }

  h1 {
    color: var(--pink);
    margin-bottom: 32px;
    text-align: center;
  }

  .form-section {
    margin-bottom: 24px;
  }

  input, textarea {
    box-sizing: border-box;
  }

  label {
    display: block;
    color: var(--pink);
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 1.1em;
  }

  .styled-dropdown,
  .styled-input,
  .styled-textarea {
    width: 100%;
    padding: 12px 16px;
    border: 2px solid var(--pink);
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.8);
    color: var(--pink);
    font-size: 0.85em;
    transition: all 0.2s ease;
  }

  .styled-dropdown:focus,
  .styled-input:focus,
  .styled-textarea:focus {
    outline: none;
    border-color: #ff8aa3;
    box-shadow: 0 0 0 3px rgba(255, 105, 138, 0.1);
  }

  .styled-dropdown option {
    background: #000;
    color: var(--pink);
  }

  .styled-textarea {
    min-height: 120px;
    resize: vertical;
    font-family: inherit;
  }

  .styled-file-input {
    width: 100%;
    padding: 12px 16px;
    border: 2px dashed var(--pink);
    border-radius: 8px;
    background: rgba(0, 0, 0, 0.4);
    color: var(--pink);
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .styled-file-input:hover {
    border-color: #ff8aa3;
    background: rgba(0, 0, 0, 0.6);
  }

  .help-text {
    margin-top: 8px;
    font-size: 0.9em;
    opacity: 0.8;
    color: var(--pink);
  }

  .form-actions {
    display: flex;
    gap: 16px;
    justify-content: center;
    margin-top: 24px;
  }

  .form-actions button[type="submit"] {
    margin: 32px 0;
    box-sizing: border-box;
    position: relative;
    background-color: var(--pink);
    color: var(--black);
    text-decoration: none;
    border: none;
    border-radius: 16px;
    padding: 8px 24px;
    font-size: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: 0.05s ease-in-out;
    box-shadow:
      6px 4px 0 0px var(--black),
      8px 2px 0 0px var(--pink),
      8px 6px 0 0px var(--pink),
      6px 6px 0 0px var(--pink);
    left: 0px;
    top: 0px;
  }

  .form-actions button[type="submit"]:hover {
    box-shadow: none;
    left: 8px;
    top: 6px;
  }

  .form-actions button[type="submit"]:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    pointer-events: none;
  }

  .form-actions button[type="submit"]:disabled:hover {
    box-shadow:
      6px 4px 0 0px var(--black),
      8px 2px 0 0px var(--pink),
      8px 6px 0 0px var(--pink),
      6px 6px 0 0px var(--pink);
    left: 0px;
    top: 0px;
  }

  .cancel-btn {
    background: transparent;
    color: var(--pink);
    border: 2px solid var(--pink);
    padding: 8px 24px;
    
    border-radius: 16px;
    font-size: inherit;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    display: inline-block;
  }

  .cancel-btn:hover {
    background: var(--pink);
    color: #000;
    transform: translateY(-2px);
  }

  .cancel-btn:active {
    transform: translateY(0);
  }

  /* Hackatime projects container */
  .hackatime-container {
    border: 2px solid var(--pink);
    border-radius: 8px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.4);
  }

  .search-input {
    margin-bottom: 12px;
  }

  .projects-list {
    max-height: 200px;
    overflow-y: auto;
    border: 1px solid rgba(255, 105, 138, 0.3);
    border-radius: 6px;
    padding: 8px;
    background: rgba(0, 0, 0, 0.6);
  }

  .project-item {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 6px 0;
    border-bottom: 1px solid rgba(255, 105, 138, 0.1);
  }

  .project-item:last-child {
    border-bottom: none;
  }

  .project-item input[type="checkbox"] {
    width: auto;
    margin: 0;
  }

  .project-item label {
    margin: 0;
    font-size: 0.95em;
    cursor: pointer;
  }

  /* Additional hours container */
  .additional-hours-container {
    border: 2px solid var(--pink);
    border-radius: 8px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.4);
  }

  .hours-input-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .hours-input {
    width: 120px;
    margin: 0;
  }

  .hours-label {
    color: var(--pink);
    font-weight: 600;
  }

  /* Justification links */
  .justification-links {
    margin-top: 16px;
  }

  .justification-links label {
    display: block;
    color: var(--pink);
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 1em;
  }

  .link-input-row {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 8px;
  }

  .justification-link {
    flex: 1;
    margin: 0;
  }

  .remove-link-btn {
    background: transparent;
    color: var(--pink);
    border: 1px solid var(--pink);
    border-radius: 4px;
    width: 24px;
    height: 24px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    flex-shrink: 0;
  }

  .remove-link-btn:hover {
    background: var(--pink);
    color: #000;
  }

  .add-link-btn {
    background: transparent;
    color: var(--pink);
    border: 1px solid var(--pink);
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
    margin-top: 8px;
  }

  .add-link-btn:hover {
    background: var(--pink);
    color: #000;
  }

  /* Scrollbar styling */
  .projects-list::-webkit-scrollbar {
    width: 8px;
  }

  .projects-list::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.3);
    border-radius: 4px;
  }

  .projects-list::-webkit-scrollbar-thumb {
    background: var(--pink);
    border-radius: 4px;
  }

  .projects-list::-webkit-scrollbar-thumb:hover {
    background: #ff8aa3;
  }

  .no-projects {
    text-align: center;
    color: var(--pink);
    opacity: 0.7;
    font-style: italic;
    padding: 20px;
  }

  /* Theme justification container */
  .theme-justification-container {
    border: 2px solid var(--pink);
    border-radius: 8px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.4);
  }

  .spins-display {
    margin-bottom: 16px;
    padding: 12px;
    background: rgba(0, 0, 0, 0.3);
    border-radius: 6px;
    border: 1px solid rgba(255, 105, 138, 0.3);
  }

  .spins-label {
    margin: 0 0 8px 0;
    color: var(--pink);
    font-weight: 600;
    font-size: 0.95em;
  }

  .spins-list {
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .spin-item {
    color: var(--pink);
    font-size: 0.9em;
    opacity: 0.9;
  }

  .spin-item strong {
    color: var(--pink);
    font-weight: 700;
  }

  .justification-input {
    margin-top: 16px;
  }

  .justification-input label {
    margin-bottom: 8px;
    font-size: 1em;
  }

  /* Screenshot preview */
  .screenshot-preview {
    margin-top: 12px;
    border: 2px solid var(--pink);
    border-radius: 8px;
    padding: 16px;
    background: rgba(0, 0, 0, 0.6);
    text-align: center;
  }

  .screenshot-preview img {
    max-width: 100%;
    max-height: 300px;
    border-radius: 6px;
    border: 1px solid rgba(255, 105, 138, 0.3);
    margin-bottom: 12px;
  }

  .remove-btn {
    background: transparent;
    color: var(--pink);
    border: 1px solid var(--pink);
    border-radius: 6px;
    padding: 6px 12px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s ease;
  }

  .remove-btn:hover {
    background: var(--pink);
    color: #000;
  }

  /* Combined summary styling */
  .combined-summary {
    border: 2px solid var(--pink);
    border-radius: 8px;
    padding: 20px;
    background: rgba(0, 0, 0, 0.6);
    margin-top: 24px;
    text-align: center;
  }

  .combined-summary h3 {
    margin: 0 0 16px 0;
    color: var(--pink);
    font-size: 1.2em;
  }

  .summary-content {
    flex-direction: column;
    gap: 12px;
  }

  .hours-section {
    flex-direction: column;
    align-items: center;
  }

  .hours-section .total-amount {
    font-size: 2em;
    font-weight: bold;
    color: var(--pink);
  }

  .hours-section .breakdown-details {
    font-size: 1em;
    color: var(--pink);
    opacity: 0.8;
  }

  .hours-comparison .comparison-text {
    color: var(--pink);
    font-size: 1.1em;
    font-weight: 600;
  }

  .hours-comparison .hours-display {
    color: var(--pink);
    font-weight: bold;
  }

  .hours-comparison .target-display {
    color: var(--pink);
    font-weight: bold;
  }

  .expected-rewards p {
    margin-bottom: 12px;
    color: var(--pink);
    font-size: 1em;
    font-weight: 600;
  }

  .rewards-breakdown {
    gap: 8px;
    color: var(--pink);
    font-size: 0.9em;
    opacity: 0.9;
  }

  .chips-reward,
  .respin-reward {
    gap: 8px;
    color: var(--pink);
    font-size: 0.9em;
    opacity: 0.9;
  }

  .chips-reward span,
  .respin-reward span {
    color: var(--pink);
    font-weight: bold;
  }
</style>
